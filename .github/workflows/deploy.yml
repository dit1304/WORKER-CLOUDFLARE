name: Deploy Cloudflare Workers
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-bot:
    name: Deploy Bot Worker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Bot Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cat > wrangler.toml << 'WRANGLER_EOF'
          name = "vpn-bot"
          main = "bot.js"
          compatibility_date = "2024-04-16"
          compatibility_flags = ["nodejs_compat"]

          [[kv_namespaces]]
          binding = "BOT_USERS"
          id = "$KV_NAMESPACE_ID"
          WRANGLER_EOF

          sed -i "s|\$KV_NAMESPACE_ID|${{ secrets.KV_NAMESPACE_ID }}|g" wrangler.toml

          sed -i "s|BOT_TOKEN_ENV|'${{ secrets.BOT_TOKEN }}'|g" bot.js
          sed -i "s|ADMIN_USERNAME_ENV|'${{ secrets.ADMIN_USERNAME }}'|g" bot.js
          sed -i "s|SERVER_VLESS_ENV|'${{ secrets.SERVER_VLESS }}'|g" bot.js
          sed -i "s|SERVER_TROJAN_ENV|'${{ secrets.SERVER_TROJAN }}'|g" bot.js
          sed -i "s|SERVER_WILDCARD_ENV|'${{ secrets.SERVER_WILDCARD }}'|g" bot.js
          sed -i "s|PASS_UID_ENV|'${{ secrets.PASS_UID }}'|g" bot.js
          sed -i "s|API_URL_ENV|'${{ secrets.API_URL }}'|g" bot.js
          sed -i "s|CF_API_TOKEN_ENV|'${{ secrets.CF_API_TOKEN }}'|g" bot.js
          sed -i "s|CF_ZONE_ID_ENV|'${{ secrets.CF_ZONE_ID }}'|g" bot.js
          sed -i "s|CF_ACCOUNT_ID_ENV|'${{ secrets.CF_ACCOUNT_ID }}'|g" bot.js
          sed -i "s|GITHUB_TOKEN_ENV|'${{ secrets.GH_TOKEN }}'|g" bot.js
          sed -i "s|GITHUB_REPO_ENV|'${{ secrets.GH_REPO }}'|g" bot.js

          wrangler deploy

      - name: Upload Users to KV
        if: hashFiles('users.json') != ''
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ -f users.json ] && [ -s users.json ]; then
            echo "Uploading user data to KV namespace..."
            npx wrangler kv bulk put --namespace-id ${{ secrets.KV_NAMESPACE_ID }} users.json
            echo "Users uploaded successfully!"
          fi

  deploy-vltr:
    name: Deploy VPN Worker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy VPN Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          cat > wrangler.toml << 'WRANGLER_EOF'
          name = "vpn-vltr"
          main = "vltr.js"
          compatibility_date = "2024-04-16"
          compatibility_flags = ["nodejs_compat"]
          WRANGLER_EOF

          # Add custom domains from domains.json if it exists
          if [ -f domains.json ] && [ -s domains.json ]; then
            echo "" >> wrangler.toml
            echo "# Custom domains (auto-generated from domains.json)" >> wrangler.toml
            for domain in $(cat domains.json | jq -r '.[]'); do
              echo "" >> wrangler.toml
              echo "[[routes]]" >> wrangler.toml
              echo "pattern = \"$domain\"" >> wrangler.toml
              echo "custom_domain = true" >> wrangler.toml
            done
            echo "Custom domains added from domains.json:"
            cat domains.json | jq -r '.[]'
          else
            echo "No domains.json found, deploying without custom domains"
          fi

          echo "--- Final wrangler.toml ---"
          cat wrangler.toml
          echo "---"

          wrangler deploy
